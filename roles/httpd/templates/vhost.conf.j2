# Generated by Ansible at {{ ansible_date_time.iso8601 }}

<VirtualHost {{ item.address | default('*') }}:{{ httpd_http_port }}>
    ServerName {{ item.name }}
{% if item.alias is defined %}
    ServerAlias {{ item.alias }}
{% endif %}
    DocumentRoot "{{ item.root | default(httpd_vhosts_web_folder + '/' + item.name + '/public_html') }}"

    SetEnvIf X-Forwarded-Proto https HTTPS=on

    <Directory "{{ item.root | default(httpd_vhosts_web_folder + '/' + item.name + '/public_html') }}">
        AllowOverride All
        Require all granted
    </Directory>

{% if item.phpfpm_pool_admin is defined %}
    <LocationMatch "{{ item.phpfpm_pool_admin_match }}">
        SetHandler "proxy:fcgi://{{ item.phpfpm_pool_admin }}"
    </LocationMatch>

{% endif -%}
{% if item.phpfpm_pool is defined %}
    <FilesMatch "\.php$">
        SetHandler "proxy:fcgi://{{ item.phpfpm_pool }}"
    </FilesMatch>
{% endif -%}
</VirtualHost>

{% if item.https is defined -%}
<VirtualHost {{ item.address | default('*') }}:{{ httpd_https_port }}>
    ServerName {{ item.name }}
{% if item.alias is defined %}
    ServerAlias {{ item.alias }}
{% endif %}
    DocumentRoot "{{ item.root | default(httpd_vhosts_web_folder + '/' + item.name + '/public_html') }}"

{% if item.https_proxypass is defined %}
    # ProxyPass will default add `X-Forwarded-For`, `X-Forwarded-Host` and `X-Forwarded-Server`
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto https
    RequestHeader set X-Forwarded-Port 443
    ProxyPass / {{ item.proxypass_address | default('http://127.0.0.1:80/') }}
{% else %}
    <Directory "{{ item.root | default(httpd_vhosts_web_folder + '/' + item.name + '/public_html') }}">
        AllowOverride All
        Require all granted
    </Directory>
{% if item.phpfpm_pool is defined %}

    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://{{ item.phpfpm_pool }}/"
    </FilesMatch>
{% endif -%}
{% endif %}

    SSLEngine On
    SSLCertificateFile {{ item.https_cert | default('/etc/pki/tls/certs/localhost.crt') }}
    SSLCertificateKeyFile {{ item.https_key | default('/etc/pki/tls/private/localhost.key') }}
{% if item.https_ca_cert is defined %}
    # SSLCertificateChainFile is deprecated in Apache 2.4.8 as `SSLCertificateFile` can now contain the intermediate
    SSLCertificateChainFile {{ item.https_ca_cert }}
{% endif %}
</VirtualHost>
{% endif %}
