# Generated by ansible-role-httpd
{# Todo: Add options for log format (eg. null uses default, "separate" uses unique for each VHost) #}
{# Todo: Add comment for SetEnvIf/fix multiline macro format, eg:
    # If behind a load balancer/SSL terminator, set HTTPS environment variable (for Application redirects - avoiding loops)
    SetEnvIf X-Forwarded-Proto https HTTPS=on
#}
{# Todo: Do I need `output_if_http` and `output_if_https` when we already know which is used from `scheme` #}

{#- =============================== Internal Macros =============================== #}

{%- macro ssl_conditional(scheme, output_if_http=false, output_if_https=false) %}
{% if scheme == "https" %}
    SSLEngine On
    SSLCertificateFile {{ item.https_cert | default('/etc/pki/tls/certs/localhost.crt') }}
    SSLCertificateKeyFile {{ item.https_key | default('/etc/pki/tls/private/localhost.key') }}
{% if item.https_ca is defined %}
    # SSLCertificateChainFile is deprecated in Apache 2.4.8 as `SSLCertificateFile` can now contain the intermediate
    SSLCertificateChainFile {{ item.https_ca }}
{% endif %}
{% if output_if_https %}

    {{ output_if_https }}
{% endif %}
{% elif ( scheme == "http" and output_if_http ) %}
    {{ output_if_http }}
{% endif %}
{% endmacro %}

{%- macro logging(log_tag=false) %}
{% if item.error_log is defined %}
    ErrorLog {{ item.error_log }}
{% endif %}
{% if item.access_log is defined %}
    CustomLog {{ item.access_log }} {{ item.access_log_format | default(httpd_log_format) }}
{% endif %}
{% endmacro %}

{%- macro site_content(scheme="http") %}
{% if ( item.docroot is defined or ( item.proxypass is not defined and item.redirect is not defined) ) %}

    DocumentRoot "{{ item.docroot | default(httpd_vhosts_web_folder + '/' + item.servername + '/public_html') }}"
{% if item.index is defined %}
    DirectoryIndex {{ item.index }}
{% endif %}

    <Directory "{{ item.docroot | default(httpd_vhosts_web_folder + '/' + item.servername + '/public_html') }}">
        AllowOverride {{ item.allow_override | default(httpd_allow_override) }}
        Options {{ item.options | default(httpd_options) }}
        Require all granted
    </Directory>
{% endif %}
{% if item.extra_parameters is defined %}

    {{ item.extra_parameters|indent(4) }}
{% endif %}
{% if item.redirect is defined %}

    redirect {{ item.redirect }}
{% endif %}
{% if item.proxypass is defined %}

    # ProxyPass will default add `X-Forwarded-For`, `X-Forwarded-Host` and `X-Forwarded-Server`
    ProxyPreserveHost On
{% if scheme == "https" %}
    RequestHeader set X-Forwarded-Proto https
    RequestHeader set X-Forwarded-Port {{ item.https_port }}
{% endif %}
    ProxyPass {{ item.proxypass }}
{% endif %}
{% if item.phpfpm is defined %}

    <FilesMatch "\.php$">
        SetHandler "proxy:fcgi://{{ item.phpfpm }}"
    </FilesMatch>
{% endif %}
{% endmacro %}

{#- =============================== VitualHost Macros =============================== #}

{%- macro vhost_alias(scheme, listen_port) %}
<VirtualHost {{ item.address | default("*") }}:{{ listen_port }}>
    ServerName redirect-{{ item.servername }}
    ServerAlias {{ item.serveralias }}
{{ logging() }}
{{ ssl_conditional(scheme, output_if_http="redirect / http://" + item.servername + "/", output_if_https="redirect / https://" + item.servername + "/") -}}
</VirtualHost>
{% endmacro %}


{%- macro vhost_content(scheme, listen_port) %}
<VirtualHost {{ item.address | default("*") }}:{{ listen_port }}>
    ServerName {{ item.servername }}
{% if ( item.serveralias is defined and not item.alias_redirect ) %}
    ServerAlias {{ item.serveralias }}
{% endif %}
{{ logging() }}
{{ ssl_conditional(scheme, output_if_http="SetEnvIf X-Forwarded-Proto https HTTPS=on") -}}
{{ site_content(scheme) -}}
</VirtualHost>
{% endmacro %}

{#- =============================== VirtualHost Logic =============================== #}

{#- First VHost is only added when we have both HTTP and HTTPS (and thus we redirect to HTTPS),
but is ignored when we are using the dual_scheme - where we serve same site_content() ony #}

{% if ( (item.http_port is defined and item.https_port is defined) and not ( item.dual_scheme| default(false) ) ) %}
# VHost for sending all traffic to HTTPS ServerName

<VirtualHost {{ item.address | default("*") }}:{{ item.http_port }}>
    ServerName {{ item.servername }}
{% if item.serveralias is defined %}
    ServerAlias {{ item.serveralias }}
{% endif %}
{{ logging() }}
    redirect / https://{{ item.servername }}/
</VirtualHost>

{% endif %}

{#- Second VHost is only added when we specify an Alias domain (and alias_redirect is true).
It uses the same scheme as the primary VHost (HTTPS when port is specified, otherwise use HTTP).
The purpose is to redirect from Alias to Primary #}
{% if ( item.serveralias is defined and item.alias_redirect ) %}
# VHost for sending all ServerAlias traffic to (correct scheme) ServerName

{% if ( item.http_port is defined and ( ( item.dual_scheme| default(false) ) or item.https_port is not defined ) ) %}
{{ vhost_alias("http", item.http_port) }}
{% endif %}

{% if ( item.https_port is defined ) %}
{{ vhost_alias("https", item.https_port) }}
{% endif %}

{% endif %}


{#- Third VHost is always present and prefers HTTPS if the port is specified #}
# VHost for serving site traffic

{% if ( item.http_port is defined and ( ( item.dual_scheme| default(false) ) or item.https_port is not defined ) ) %}
{{ vhost_content("http", item.http_port) }}
{% endif %}

{% if ( item.https_port is defined ) %}
{{ vhost_content("https", item.https_port) }}
{% endif %}
